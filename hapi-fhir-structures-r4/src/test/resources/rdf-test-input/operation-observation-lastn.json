{
  "resourceType": "OperationDefinition",
  "id": "Observation-lastn",
  "text": {
    "status": "generated",
    "div": "\u003cdiv xmlns\u003d\"http://www.w3.org/1999/xhtml\"\u003e\u003ch2\u003eLast N Observations Query\u003c/h2\u003e\u003cp\u003eOPERATION: Last N Observations Query\u003c/p\u003e\u003cp\u003eThe official URL for this operation definition is: \u003c/p\u003e\u003cpre\u003ehttp://hl7.org/fhir/OperationDefinition/Observation-lastn\u003c/pre\u003e\u003cdiv\u003e\u003cp\u003eThe \u003cem\u003elastn query\u003c/em\u003e meets the common need for searching for the most recent or last n\u003dnumber of observations for a subject. For example, retrieving the last 5 temperatures for a patient to view trends or fetching the most recent laboratory results or vitals signs. To ask a server to return the last n\u003dnumber of observations, the \u003cem\u003elastn\u003c/em\u003e query uses the \u003ca href\u003d\"observation.html#search\"\u003enormal search parameters\u003c/a\u003e defined for the Observation resource.  However, rather than their normal use, they are interpreted as inputs - i.e.. instead of requiring that the resources literally contain the search parameters, they are passed to a server algorithm of some kind that uses them to determine the most appropriate matches.\u003c/p\u003e\n\u003cp\u003eThe request for a lastn query SHALL include:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA \u003ccode\u003e$lastn\u003c/code\u003e operation parameter\u003c/li\u003e\n\u003cli\u003eA subject using either the \u003ccode\u003epatient\u003c/code\u003e or \u003ccode\u003esubject\u003c/code\u003e  search parameter\u003c/li\u003e\n\u003cli\u003eA \u003ccode\u003ecategory\u003c/code\u003e parameter and/or a search parameter that contains a code element in its FHIRpath expression.  ( e.g., \u003ccode\u003ecode\u003c/code\u003e or \u003ccode\u003ecode-value-concept\u003c/code\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe request for a lastn query MAY include:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOther Observation search parameters and modifiers\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe response from a lastn query is a set of observations:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFiltered by additional parameters\n\u003cul\u003e\n\u003cli\u003eIf not explicitly filtered by status then will include statuses of \u0027entered-in-error\u0027\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u0027GROUP BY\u0027 \u003ccode\u003eObservation.code\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003eCodes SHALL be considered equivalent if the \u003ccode\u003ecoding.value\u003c/code\u003e \u003cem\u003eand\u003c/em\u003e \u003ccode\u003ecoding.system\u003c/code\u003e are the same.\u003c/li\u003e\n\u003cli\u003eText only codes SHALL be treated and grouped based on the text.\u003c/li\u003e\n\u003cli\u003eFor codes with translations (multiple codings), the code translations are assumed to be equal and the grouping by code SHALL follow the transitive property of equality.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003efor example:\u003c/p\u003e\n\u003ctable class\u003d\"grid\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\u003cth\u003eObservation.code for observation a\u003c/th\u003e\u003cth\u003eObservation.code for observation b\u003c/th\u003e\u003cth\u003eObservation.code for observation c\u003c/th\u003e\u003cth\u003enumber of groups [codes/text in each group]\u003c/th\u003e\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\u003ctd\u003ea\u003c/td\u003e\u003ctd\u003eb\u003c/td\u003e\u003ctd\u003ec\u003c/td\u003e\u003ctd\u003e3 [a],[b],[c]\u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003ea\u003c/td\u003e\u003ctd\u003eb\u003c/td\u003e\u003ctd\u003ea,c\u003c/td\u003e\u003ctd\u003e2 [a.c],[b]\u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003ea\u003c/td\u003e\u003ctd\u003eb\u003c/td\u003e\u003ctd\u003ea,b\u003c/td\u003e\u003ctd\u003e1 [a,b]\u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003e\u0027textM\u0027\u003c/td\u003e\u003ctd\u003e\u0027Text\u0027\u003c/td\u003e\u003ctd\u003e\u0027t e x t\u0027\u003c/td\u003e\u003ctd\u003e3 [\u0027text\u0027],[\u0027Text\u0027],[\u0027t e x t\u0027]\u003c/td\u003e\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cul\u003e\n\u003cli\u003eSorted from most recent to the oldest\u003c/li\u003e\n\u003cli\u003eLimited to the number of requested responses per group specified by the optional \u003cem\u003emax\u003c/em\u003e query parameter\n\u003cul\u003e\n\u003cli\u003eIn case of a tie - when the effective times for \u0026gt;1 Observations are equal - both will be returned.  Therefore, more Observations may be returned than is specified in \u003cem\u003emax\u003c/em\u003e.  For example, 4 Observations instead of 3 if the 3rd and 4th most recent observation had the same effective time.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eIf no maximum number is given then only the most recent Observation in each group is returned.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe set of returned observations should represent distinct real world observations and not the same observation with changes in status or versions. If there are no matches, the \u003cem\u003elastn\u003c/em\u003e query SHALL return an empty search set with no error, but may include an operation outcome with further advice.\u003c/p\u003e\n\u003c/div\u003e\u003cp\u003eURL: [base]/Observation/$lastn\u003c/p\u003e\u003cp\u003eParameters\u003c/p\u003e\u003ctable class\u003d\"grid\"\u003e\u003ctr\u003e\u003ctd\u003e\u003cb\u003eUse\u003c/b\u003e\u003c/td\u003e\u003ctd\u003e\u003cb\u003eName\u003c/b\u003e\u003c/td\u003e\u003ctd\u003e\u003cb\u003eCardinality\u003c/b\u003e\u003c/td\u003e\u003ctd\u003e\u003cb\u003eType\u003c/b\u003e\u003c/td\u003e\u003ctd\u003e\u003cb\u003eBinding\u003c/b\u003e\u003c/td\u003e\u003ctd\u003e\u003cb\u003eDocumentation\u003c/b\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003eIN\u003c/td\u003e\u003ctd\u003emax\u003c/td\u003e\u003ctd\u003e0..1\u003c/td\u003e\u003ctd\u003e\u003ca href\u003d\"datatypes.html#positiveInt\"\u003epositiveInt\u003c/a\u003e\u003c/td\u003e\u003ctd/\u003e\u003ctd\u003e\u003cdiv\u003e\u003cp\u003e\u003ccode\u003emax\u003c/code\u003e is  an optional input parameter to the \u003cem\u003elastn\u003c/em\u003e query operation.  It is used to specify the maximum number of Observations to return from each group. For example for the query \u0026quot;Fetch the last 3 results for all vitals for a patient\u0026quot; \u003ccode\u003emax\u003c/code\u003e \u003d 3.\u003c/p\u003e\n\u003c/div\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003eOUT\u003c/td\u003e\u003ctd\u003ereturn\u003c/td\u003e\u003ctd\u003e1..1\u003c/td\u003e\u003ctd\u003e\u003ca href\u003d\"bundle.html\"\u003eBundle\u003c/a\u003e\u003c/td\u003e\u003ctd/\u003e\u003ctd\u003e\u003cdiv\u003e\u003cp\u003eThe set of most recent N Observations that match the \u003cem\u003elastn\u003c/em\u003e query search criteria.\u003c/p\u003e\n\u003c/div\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\u003cdiv\u003e\u003cp\u003eThe key differences between this query operation and simply searching Observation using the combination of \u003ccode\u003e_count\u003c/code\u003e and \u003ccode\u003e_sort\u003c/code\u003e parameters are:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe \u003cem\u003elastn\u003c/em\u003e query returns \u003cstrong\u003eonly\u003c/strong\u003e the last N resource grouped by code.  Using the _count query method doesn\u0027t restrict the total matches so you may need to page through several \u0026quot;A\u0026quot; Observations  before getting to Observation \u0026quot;B\u0026quot;.\u003c/li\u003e\n\u003cli\u003eThe server is responsible for grouping the observations by codes.  This frees the client from needing to determine which codes she should ask for.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis operation cannot be performed on observations that the user is not authorized to see.  It is assumed that the server has identified and secured the context appropriately, and can either associate the authorization context with a single patient, or determine whether the context has the rights to the nominated patient, if there is one. If there is no nominated patient (e.g. the operation is invoked at the system level) and the context is not associated with a single patient record, then the server should return an error. Specifying the relationship between the context, a user and patient records is outside the scope of this specification.\u003c/p\u003e\n\u003c/div\u003e\u003c/div\u003e"
  },
  "extension": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm",
      "valueInteger": 3
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status",
      "valueCode": "trial-use"
    }
  ],
  "url": "http://hl7.org/fhir/OperationDefinition/Observation-lastn",
  "version": "4.0.1",
  "name": "Last N Observations Query",
  "status": "draft",
  "kind": "operation",
  "date": "2019-11-01T09:29:23+11:00",
  "publisher": "HL7 (FHIR Project)",
  "contact": [
    {
      "telecom": [
        {
          "system": "url",
          "value": "http://hl7.org/fhir"
        },
        {
          "system": "email",
          "value": "fhir@lists.hl7.org"
        }
      ]
    }
  ],
  "description": "The *lastn query* meets the common need for searching for the most recent or last n\u003dnumber of observations for a subject. For example, retrieving the last 5 temperatures for a patient to view trends or fetching the most recent laboratory results or vitals signs. To ask a server to return the last n\u003dnumber of observations, the *lastn* query uses the [normal search parameters](observation.html#search) defined for the Observation resource.  However, rather than their normal use, they are interpreted as inputs - i.e.. instead of requiring that the resources literally contain the search parameters, they are passed to a server algorithm of some kind that uses them to determine the most appropriate matches.\n\nThe request for a lastn query SHALL include:\n\n* A `$lastn` operation parameter\n*  A subject using either the `patient` or `subject`  search parameter\n*  A `category` parameter and/or a search parameter that contains a code element in its FHIRpath expression.  ( e.g., `code` or `code-value-concept`)\n\nThe request for a lastn query MAY include:\n\n* Other Observation search parameters and modifiers\n\nThe response from a lastn query is a set of observations:\n\n*  Filtered by additional parameters\n   * If not explicitly filtered by status then will include statuses of \u0027entered-in-error\u0027\n* \u0027GROUP BY\u0027 `Observation.code`\n   * Codes SHALL be considered equivalent if the `coding.value` *and* `coding.system` are the same.\n   * Text only codes SHALL be treated and grouped based on the text.\n   * For codes with translations (multiple codings), the code translations are assumed to be equal and the grouping by code SHALL follow the transitive property of equality.\n\nfor example:\n\n|Observation.code for observation a|Observation.code for observation b|Observation.code for observation c|number of groups [codes/text in each group]|    \n|---|---|---|---|     \n|a|b|c | 3 [a],[b],[c]|    \n|a|b|a,c | 2 [a.c],[b]|     \n|a|b|a,b | 1 [a,b]|    \n|\u0027textM\u0027|\u0027Text\u0027|\u0027t e x t\u0027|3 [\u0027text\u0027],[\u0027Text\u0027],[\u0027t e x t\u0027]|\n\n* Sorted from most recent to the oldest\n* Limited to the number of requested responses per group specified by the optional *max* query parameter\n  * In case of a tie - when the effective times for \u003e1 Observations are equal - both will be returned.  Therefore, more Observations may be returned than is specified in *max*.  For example, 4 Observations instead of 3 if the 3rd and 4th most recent observation had the same effective time.\n* If no maximum number is given then only the most recent Observation in each group is returned.\n\nThe set of returned observations should represent distinct real world observations and not the same observation with changes in status or versions. If there are no matches, the *lastn* query SHALL return an empty search set with no error, but may include an operation outcome with further advice.",
  "code": "lastn",
  "comment": "The key differences between this query operation and simply searching Observation using the combination of `_count` and `_sort` parameters are:\r\r* The *lastn* query returns **only** the last N resource grouped by code.  Using the _count query method doesn\u0027t restrict the total matches so you may need to page through several \"A\" Observations  before getting to Observation \"B\".\r* The server is responsible for grouping the observations by codes.  This frees the client from needing to determine which codes she should ask for.\r\rThis operation cannot be performed on observations that the user is not authorized to see.  It is assumed that the server has identified and secured the context appropriately, and can either associate the authorization context with a single patient, or determine whether the context has the rights to the nominated patient, if there is one. If there is no nominated patient (e.g. the operation is invoked at the system level) and the context is not associated with a single patient record, then the server should return an error. Specifying the relationship between the context, a user and patient records is outside the scope of this specification.",
  "resource": [
    "Observation"
  ],
  "system": false,
  "type": true,
  "instance": false,
  "parameter": [
    {
      "name": "max",
      "use": "in",
      "min": 0,
      "max": "1",
      "documentation": "`max` is  an optional input parameter to the *lastn* query operation.  It is used to specify the maximum number of Observations to return from each group. For example for the query \"Fetch the last 3 results for all vitals for a patient\" `max` \u003d 3.",
      "type": "positiveInt"
    },
    {
      "name": "return",
      "use": "out",
      "min": 1,
      "max": "1",
      "documentation": "The set of most recent N Observations that match the *lastn* query search criteria.",
      "type": "Bundle"
    }
  ]
}